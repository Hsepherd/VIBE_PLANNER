import OpenAI from 'openai'
import fs from 'fs'

// 手動讀取 .env.local
const envContent = fs.readFileSync('.env.local', 'utf-8')
const envLines = envContent.split('\n')
envLines.forEach(line => {
  const [key, ...valueParts] = line.split('=')
  if (key && valueParts.length) {
    process.env[key.trim()] = valueParts.join('=').trim()
  }
})

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

// 今天日期
const getTodayDate = () => {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  const weekdays = ['日', '一', '二', '三', '四', '五', '六']
  const weekday = weekdays[now.getDay()]
  return { year, month, day, weekday, full: `${year}-${month}-${day}` }
}

// 優化後的 prompt
const getMeetingTranscriptPrompt = () => {
  const today = getTodayDate()

  return `你是「會議逐字稿 → 待辦清單萃取助手」，專門從長篇會議記錄中精準萃取行動項目。
你的目標不是做會議摘要，而是成為「行動項目雷達」—— 找出所有需要後續執行的事項。

## 今天的日期
今天是 ${today.year} 年 ${today.month} 月 ${today.day} 日，星期${today.weekday}。
請將相對日期（如「下週三」「月底前」「明天」）轉換為具體的 YYYY-MM-DD 格式。

---

## 一、什麼算「待辦」？（判斷標準）

從逐字稿中識別以下語氣與句型：

### 1. 明確行動（action）
- 「我們要…」「你幫我…」「我會去…」「記得要…」
- 「這個之後要整理」「這個要優化一下」「這個要給 XX 看」
- 「我來處理」「好」「沒問題」「OK」（代表接下任務）

### 2. 準備工作（prep）
- 「下次會議前先…」「到時候要先做好…」
- 「先準備一下」「先整理好」

### 3. 跟進追蹤（follow-up）
- 「這個之後要再確認」「我們之後要回頭看這個數字」
- 「再約時間」「下次再談」「要追蹤」「要拉回來」

### 4. 決策待定（decision）
- 「這個方向先記著，下次再決定」「這個可以研究一下，看要不要做」
- 「這個要再想想」「先保留」

### 關鍵原則
✅ 只要是「未來需要做什麼、查什麼、改什麼、決定什麼」都是待辦
❌ 純聊天、情緒抒發、閒聊不算待辦

---

## 二、萃取每個待辦必須包含的欄位

### 1. title（任務標題）
- 一句話、具體、可執行
- 10-20 字，例如：「整理 Vicky 課的收入分配章節備註」

### 2. assignee（負責人）
- 如果逐字稿中有明確提到誰負責，就填那個人
- 如果沒有明講，填 null

### 3. task_type（任務類型）
- \`action\`：直接要做的事情
- \`follow-up\`：需要之後追蹤／確認
- \`decision\`：未來要再做決策的點
- \`prep\`：準備工作

### 4. priority（優先級）
根據語氣判斷：
- \`urgent\`：有時效、提到「立刻」「今天」「緊急」「馬上」
- \`high\`：提到「這週」「儘快」「重要」、下次會議前要完成、被重複強調
- \`medium\`：提到「下週」「近期」、一般跟進事項
- \`low\`：沒有明確時間壓力、建議性質

### 5. description（任務說明）—— 最重要的欄位！
**字數要求：300-500 字（非常重要！不要太短！）**

必須包含以下四個部分，每個部分都要詳細：

**A. 任務摘要（2-3句）**
- 說明這個任務是什麼
- 為什麼需要做這件事
- 這個任務的目標是什麼

**B. 執行細節（用編號列出 3-6 個步驟）**
具體說明執行步驟，例如：
1. 第一步要做什麼
2. 第二步要做什麼
3. 需要注意的事項
4. 完成標準是什麼

如果有提到產出形式（文件、簡報、Notion、表格），請明確寫進去
如果有提到特定工具或資源，請列出

**C. 【會議脈絡】（2-3 段詳細說明）**
詳細整理討論背景，必須包含：
- 誰提出這個需求？為什麼？
- 討論過程中有什麼重要觀點？
- 大家對這件事的看法是什麼？
- 這個任務與其他事項的關聯？

用整理過的中文，但要保留完整脈絡，讓讀者不用回看逐字稿就能理解

**D. 【原文引用】（引用 3-5 段關鍵對話）**
從逐字稿中選取最關鍵的原句，格式：
「【時間戳】講者：原話內容」

範例：
「【00:15:30】Orange：這個課程的收入分配要重新整理一下，現在的版本太亂了。」
「【00:16:45】Hsepherd：好，那我們先把 Vicky 課的部分整理出來。」
「【00:17:20】Orange：對，重點是要讓老師看得懂，知道自己分到多少。」

如果逐字稿沒有時間戳，可以寫【會議中】

### 6. due_date（截止日期）
- 根據討論內容推斷，轉換為 YYYY-MM-DD
- 如果沒有明確提及，填 null

### 7. project（相關專案）
- 如能判斷出相關專案／主題，填入
- 例如：「Vicky 課」「Elena 課」「AI 系統」「廣告優化」

---

## 三、特別注意的關鍵詞模式

| 關鍵詞 | 代表含義 |
|--------|----------|
| 「好」「好好」「好沒問題」「OK」 | 接下任務 |
| 「要」「需要」「應該」「可以」 | 待辦事項 |
| 「先」「待會」「之後」「下次」 | 跟進事項 |
| 「拉回來」「追蹤」「跟進」「再聯絡」 | 客戶任務 |
| 「優化」「改善」「調整」「改成」 | 改進任務 |
| 「整理」「準備」「建立」「補上」 | 文件/系統任務 |
| 人名 + 動作 | 分配任務給特定人 |

---

## 四、萃取原則（非常重要！）

### 1. 寧可多抓，不要漏抓
- 目標：從會議中萃取 **8-20 項** 任務
- 如果不確定是否為任務，**先列出來讓使用者自己刪除**
- 每個說「好」「沒問題」的人，通常會有任務分配到

### 2. 不要只做純摘要
❌ 「這段在聊天」
✅ 「根據討論，需要準備 XX 話術」

### 3. 合併重複任務
如果同一個任務在不同時間被反覆提到：
- 合併成一個任務
- 在【原文引用】列出多個時間點的原句

### 4. 保留完整脈絡
讓讀者不需要回看逐字稿，就能理解任務的來龍去脈

---

## 五、回應格式（必須嚴格遵守）

\`\`\`json
{
  "type": "tasks_extracted",
  "meeting_summary": "會議摘要（100-300字），包含：1. 主要討論內容 2. 重要結論 3. 整體方向",
  "tasks": [
    {
      "title": "精簡任務標題（10-20字）",
      "assignee": "負責人 或 null",
      "task_type": "action | follow-up | decision | prep",
      "priority": "urgent | high | medium | low",
      "description": "【任務摘要】\\n這是一個關於XXX的任務，目的是為了達成YYY。因為會議中討論到ZZZ的問題，所以需要進行這項工作。\\n\\n【執行細節】\\n1. 首先要做的事情\\n2. 接著需要處理的部分\\n3. 需要注意的重點\\n4. 產出形式（如：Notion文件、Excel表格）\\n5. 完成標準\\n\\n【會議脈絡】\\nXXX 在會議中提出了這個需求，主要是因為目前YYY的狀況需要改善。\\n\\n大家討論後認為應該從ZZZ方向著手，Orange 也補充說明了相關的背景資訊。\\n\\n這個任務與其他專案的關聯是...，預期完成後可以達到...的效果。\\n\\n【原文引用】\\n「【00:15:30】Orange：這個課程的收入分配要重新整理一下。」\\n「【00:16:45】Hsepherd：好，那我們先把這部分整理出來。」\\n「【00:17:20】Orange：對，重點是要讓大家看得懂。」\\n「【00:18:00】Karen：我覺得可以用表格的方式呈現。」",
      "due_date": "YYYY-MM-DD 或 null",
      "project": "專案名稱 或 null"
    }
  ],
  "key_decisions": [
    "重要決議1（本次會議確定的事項）",
    "重要決議2"
  ],
  "follow_ups": [
    "需要後續跟進但還不是明確任務的事項"
  ],
  "message": "已從會議中萃取 X 項待辦事項，包含 Y 項高優先級任務。"
}
\`\`\`

**description 範例（這是一個完整的 description 應該長什麼樣子）：**

\`\`\`
【任務摘要】
整理 Vicky 課程的收入分配章節備註，確保講師能清楚了解自己的分潤比例和計算方式。這項工作源於目前的分配表格過於複雜，講師反映看不懂。

【執行細節】
1. 從現有的 Notion 資料中整理出 Vicky 課程的所有收入來源
2. 列出各項收入的分配比例（平台費、講師費、行政費）
3. 製作簡化版的分配說明表格
4. 加入計算範例，讓講師一看就懂
5. 完成後需要給 Vicky 確認過目
6. 最終產出：Notion 文件 + 一頁式說明圖

【會議脈絡】
Orange 在會議中提出這個需求，因為 Vicky 最近詢問了好幾次關於收入分配的問題，顯示目前的文件不夠清楚。

Hsepherd 同意這個優先處理，並指出不只是 Vicky 課，其他老師的課程也應該比照辦理。Karen 建議可以做一個通用的模板，之後其他課程也可以套用。

這個任務完成後，預計可以減少講師的疑問，也讓財務對帳更順暢。

【原文引用】
「【00:15:30】Orange：Vicky 那邊又問了一次收入怎麼算的，我們現在的表格太複雜了。」
「【00:16:00】Hsepherd：對，這個要處理一下，不然每次都要解釋半天。」
「【00:16:45】Karen：我覺得可以做一個簡化版的，就一頁說明清楚。」
「【00:17:20】Orange：好，那就先從 Vicky 課開始，做好之後其他課也比照。」
\`\`\`

---

## 六、輸出前自我檢查清單

在輸出 JSON 前，請逐一確認：

1. ✅ 是否萃取了至少 6 項任務？（少於 6 項請重新閱讀！）
2. ✅ **每個 description 是否達到 300-500 字？（這是最重要的！太短就重寫！）**
3. ✅ 每個 description 是否都包含完整的四個部分？
   - 【任務摘要】2-3 句話
   - 【執行細節】3-6 個編號步驟
   - 【會議脈絡】2-3 段背景說明
   - 【原文引用】3-5 段逐字稿引用（含時間戳）
4. ✅ 是否涵蓋了以下類型的任務？
   - 明確行動（要做的事）
   - 客戶/學生跟進
   - 流程/話術改進
   - 系統/工具建設
   - 文件/資料整理
5. ✅ 每個說「好」「沒問題」的人是否都有任務？
6. ✅ 所有相對日期是否都已轉換為 YYYY-MM-DD？
7. ✅ 優先級是否根據語氣正確判斷？

**⚠️ 特別注意：如果 description 太短（少於 300 字），請立即重寫！**
**用戶需要詳細的任務說明，而不是簡短的摘要。**

**如果任何一項不通過，請回去修正！**
`
}

// 完整會議逐字稿
const transcript = `# 每週成果會議 / 每日站立會議
Meeting started: 11/27/2025, 1:00:48 PM
Duration: 183 minutes
Participants: hsepherd zheng, Hsepherd Zheng, Karen Chin, Kelly, Vicky Huang, 易叡 許, 簡單歌唱 Singple., 詩晴 林

## Transcript

01:05 Speaker: 掃一好，那有些東西沒有達標，然預約數量是有達標的。然後有一個學員主動預約，然後找個率又預約，所以目前電腦的狀況其實蠻穩定的，然後這裏來講一下九九九的問題因爲我昨天我一去看他昨天打九九九的狀況那這邊講的時間都沒有超過兩分鍾的樣子

03:00 Speaker: 有一意的聽完學生的明確都有一個明確表達，就是他先不用他報了報別家學那個唱歌，課，然後呃，再來哦，因爲我現在就是學生拒絕的話我都叫校校給他們開上菜單

03:22 Speaker: 不用，然後就直接掛電話。然後就是一開始他說簡單歌唱的時候，他就會直接說他先不用然後就掛電話

04:00 Speaker: 對要聽全部的，要全部的。對我昨天是聽昨天的音檔，我要聽全部的嗎？哦，好好好那我今天把全部聽了。

05:35 Speaker: 好啊好啊。Ok，那就。好。對，那今天的主要任務就是排成viki的開場菜單的短片，然後昨天是發布的wiki的唱歌整好式的影片以及唱展的信件然後以下是信件的數據開進率是二十一點八趴然後點擊率是零點二九趴CTOR是一點三二趴

06:48 Speaker: 對了，那個我再報告一下關於信件的部分信件的部分，我有請那個marnies在幫我去分析一下具體的信件的內容對然後他又給出一些措施然後我會把它的措施再結合那個我們的ai對我會再把那些指令再去做優化，就是針對於我們強推銷的信件，這部分。

07:35 Speaker: 好，那這周撥打通話數是有達標的，然後也有超標，然後有時候監控處比較偏低，就是還是是比較最大的問題然後電房預約數是有達標的然後主動約也就是有意外收獲三個所以這周約了，十九個那照稿率平均九十二歲是穩定的

08:19 Speaker: 呃，這周總共取消了三位，啊，主要取消原因是一個，一個是學員主動取消，然後一個是要改期因爲它應該會上傳然後哦，還有一個也是一男未上傳然後還沒有重新預約要再追蹤那地方人員都持續在追蹤所以目前這周應該是約了三個這十六位

09:00 Speaker: 周跟好，那未來可不可以周匯報告這個這周跟上周的數據的相比。就是預約預約，放以及取消取消的那種。就是他的意思，就是說，我們要看到是成長還是下跌。對整個區域系。

10:30 Speaker: 好，那你那你作爲你，到時候你今天去做一下趨勢好了。好。嗯，就看一下整體的狀況。好，我明天一批報告嗎？

11:00 Speaker: 就是笑笑來之後每個禮拜的趨勢吧。好。所以十月不用嗎？十一月就好了。其實就就是這個月啦這這個月從他是從二十七號嘛，我記得是二十七號開始就是十月二十七號到十一月二十六號就是這一整個月。

13:24 Speaker: 我覺得現在的預約數是不錯，但我覺得質量就沒有這麼的好，就是要賣大筆的有點困難

21:00 Speaker: 好，那那這裏就沒什麼問題。嗯。那就給開倫吧。

27:35 Speaker: 好，那我們本周的平均觀看數是十二萬五千四百零一，然後平均留言數是兩百八十六平均留言率是零點二三趴然後平均分享數是七百五十一平均觀察長是十五秒

28:34 Speaker: 這個頁面是可以我們可以在網頁上看得到了嗎？還是你，這還是在本機裏面？這我已經部署了。Okay，所以現在已經可以可以注冊，可以登入看。

37:14 Speaker: 我覺得這個部分哦，可以跟你們你們行銷組的時候，開會的時候可以跟組員討論一下這個部分。然後然後再再一起看看說，哎，未來可以怎麼樣，因爲因爲這個主要是要組員們去學習的那未來才可以拍得更好。

43:21 Speaker: 哦，標準的話，高價值是，一，我們有啊，就是開場菜單嘛，或者是什麼樣子的高音頻啊，這個我們有六個庫有

45:00 Speaker: 誒說到開場菜單，我們的開場現在二點零的短片已經上了嘛。上了一只對。我覺得在前幾天對上了一只是對不對。然後他的manager是怎麼樣串的？嗯，matter是串到我們官方line。

46:22 Speaker: 欸有有因爲沒理解，就是我們minitor串什麼，就讓他們請他們留言這樣子嗎？這樣講表演過啊。嗯，所以你可能他們在點擊ct之後嘛。Okay你是不是要領開場菜單啊？是的話然後下一個就是ok，那領取開場菜單之前呃，你的email是什麼？因爲我們要寄給你，然後就問他的疫苗。然後再來就是他怎麼稱呼你。

47:21 Speaker: 然後我們就可以後面就可以推他的體驗課。好，那這個要怎麼操作？我們，你先看一下，之前因爲我之前有做過，你看一下我之前做的那個模板然後你把它復制過去應該就可以了。

48:00 Speaker: Okay好然後上次有說自動化信件什麼時候會更新上去嗎？好像沒有。Okay。長片是什麼時候出來？長片是下周一兒。下走一二。對。那就長片。長片出來之後。就可以更新上去，跟下周下周三更新到自動化信件裏面。

53:21 Speaker: 他指的這個體驗課是什麼意思？就是我們那個S音診斷體驗課。Okay所以他是指全部的信件加總的平均是嗎？對對。

55:00 Speaker: 就是他後面有給一些策略嘛。對啊。Okay對，你可以先定一下，所以現在這個是低的，是偏低的kpi嗎？還是是正常的？誒，這應該是偏低的，就是如果跟。哦，那後面有給你整體行業平均哦。對。Okay好，那爲什麼？就是因爲我們內容有點太推。Okay。那時候價值類的就是比較少一點。

56:00 Speaker: 價值類佔比較少，然後推客佔比較多，對未來可能他提供建議是價值類的要在七十帕然後推銷內容佔比可能頂多三十帕。他有給就是具體的優化後的信件長什麼樣子嗎？安，沒有哎。

57:00 Speaker: 我覺得可以請他一下，就是先確定一下他的地圖跟你看到地圖是不是一樣的。然後然後再去優化。對啊，因爲其實你平常就一直在記很多價值信件的。所以我覺得應該應該可能還有其他問題。

58:00 Speaker: 這個大概什麼時候可以再看到優化過後的樣子。應該明天吧。哦，這麼快好啊，好好好沒問題可以。

58:45 Speaker: 就是要做alana跟viki要去大師的react，他們的去年的翻唱影片。Okay再確定一下。所以你剛剛是說你剛剛已經講好了那個是哪個版本？付費，你說你，我們。呃，付費的版本就是幹貨內容的。

01:04:32 Speaker: 嗯。對，所以這個是單獨剪出來。得了，然後到最後一個一個什麼高音的對對對單獨拉出來精華片段對。所以這個場面應該是沒有。對吧？就是把它單獨拉出來，作爲精華片段，再再一次。

01:10:34 Speaker: 誒，這個長片拍完了嗎？是馬場命嗎？還有拍好了。是是我們上周開會講的那個三個類型之一嗎？對這我還沒看過。

01:14:02 Speaker: 那這樣是不是還有一只長片？什麼產品。就是完整版的片。現有開場餐短片。跟長片。誒，周二是長片對不對？誒，我們剛剛不是我們剛對我們剛剛應該是排長片。Okay。完整版。

01:19:27 Speaker: 那就先二十二，二十三。這個是剪輯嗎？還是發布？發布。Oh發布就一周一只吧。那就十五誒十六，二十三。Okay啊。

01:24:54 Speaker: 就是中英字幕的話。還是哦okay okay，那你那你評估一下，反正畫面的部分就是只有這樣然後可能花比較久的字幕這樣然後你不用做任何剪輯。對對對，我想我是在想說字幕會比較久。好好好，那那你評估多久？你跟討論一下。

01:31:57 Speaker: Okay。好呃，在上一周從二十號到二十六號，我們總共諮詢數是十六位，然後上線的人數是十四位成交的人數是八位成交率是五十趴然後上一周的實收金額是二十八萬零六百二十二平均成交金額是三萬五千零七十八

01:32:18 Speaker: 那在上周的話，這邊可以明顯看到呃。我們的實收精的已經提升了五千五百一十二帕因爲上周真的是蠻慘的對然後我們的上限率也有達到八十七點五帕

01:33:15 Speaker: 的問題還是卡在現在七六八的名單比較少，然後我們是在努力的轉向，希望能夠從九九九體驗課來源那邊的名單去提升我們的諮詢的質量。

01:35:04 Speaker: 我們會在明天的業務組會議我們要去優化未來我們的諮詢流程，所以這邊也要請諮詢師們。呃，仔細聽一下，對我們會在明天的業務組會議需要請諮詢師們準備好，你們可能過去有做過或者是沒做過如果沒做過的話就是待會會後的時候去完成一下明天在業務組會議的時候要去準備你們目前諮詢的煙圈地圖也就是你們現在諮詢的sop流程。

01:35:30 Speaker: Ok，這是第一個，然後第二個是反對意見的話術表ok那這個反對意見的話，術表呃，我記得過去我們有整理過一個資料表對但是這邊你們還是需要用你們自己會說的話，寫上去就是不要貼上來就看起來像gpt寫的一樣

01:35:57 Speaker: 然後再來第三項就是後設的資料庫okay因爲你們在做每一個諮詢的每一個環節有不同的後設嘛。然後你們要去針對你們的煙圈寫上，比方說你在第一個流程可能是去呃，建立信任感或者是你要去收集學員的痛點等等

01:36:43 Speaker: 我再總結一次第一個要準備的是煙圈地圖然後第二個是反對意見的話術表要用自己的畫寫然後第三個是後設的資料庫第四個是畫素的逐字資料庫ok嗎？

01:37:14 Speaker: 對，那我也講一下爲什麼要整理這些東西？因爲我們現在已經開始在用我們現在的ai系統了，那未來我會希望因爲現在諮詢師們都是自己用gpt去優化嘛，但gpt呃，雖然他給出來的結果都還不錯但是他沒有辦法去結合學生的詳細背景

01:50:28 Speaker: 好。呃，我。我會自己約啦如果是自己的學生。We kina。是？哦，我，我基本上也會問他就是下一次上課什麼時候，但是有些人不一定會他就說，他可能很忙，然後他再想想他自己再來小編就有可能對。

01:52:13 Speaker: 嗯嗯。那邊就先約好還是怎麼樣子，因爲你已經跟學生就像好了，他是跟學生巧合時間然後叫學生自己去跟客服約那老師就不會有這個責任的問題了。

01:53:44 Speaker: 看一下哦。我確定一下。不對，應該是應該是一百帕。嗯。我確定一下你是不是有有有四位學生是上周四完成的？

02:05:32 Speaker: 好，那就看老師們有沒有什麼反饋的，沒有的話就請客人繼續。

02:50:27 Speaker: 這個課程最大的重點就是哦，如果他要成爲表演者一樣，像你就是可以可以買車買房的話，那他的歌唱專業技巧就不是不能只停留在興趣因爲興趣會很容易可能唱快嗓子或什麼之類的所以後設是引導他們去報你的高階課
`

async function main() {
  console.log('開始測試優化後的 prompt...\n')

  try {
    const response = await openai.chat.completions.create({
      model: 'gpt-4o',
      messages: [
        { role: 'system', content: getMeetingTranscriptPrompt() },
        { role: 'user', content: transcript },
      ],
      temperature: 0.3,
      max_tokens: 16000,
    })

    const result = response.choices[0].message.content
    console.log('=== AI 萃取結果 ===\n')
    console.log(result)

    // 嘗試解析 JSON
    try {
      const jsonMatch = result.match(/```json\n?([\s\S]*?)\n?```/)
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[1])
        console.log('\n\n=== 萃取統計 ===')
        console.log(`任務數量: ${parsed.tasks?.length || 0}`)
        if (parsed.tasks) {
          parsed.tasks.forEach((task, i) => {
            console.log(`\n任務 ${i + 1}: ${task.title}`)
            console.log(`  - 負責人: ${task.assignee || '未指定'}`)
            console.log(`  - 優先級: ${task.priority}`)
            console.log(`  - description 字數: ${task.description?.length || 0}`)
          })
        }
      }
    } catch (e) {
      console.log('JSON 解析失敗，但原始結果已輸出')
    }

  } catch (error) {
    console.error('錯誤:', error.message)
  }
}

main()
