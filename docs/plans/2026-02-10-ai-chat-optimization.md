# AI å°è©±ç³»çµ±å„ªåŒ–è¨ˆç•«

> æ—¥æœŸï¼š2026-02-10
> åŸºæ–¼ 10 è¼ªå¯¦éš›æ¸¬è©¦ + æ¶æ§‹åˆ†æç”¢å‡º

---

## æ¸¬è©¦ç™¼ç¾çš„å•é¡Œï¼ˆä¾åš´é‡åº¦æ’åºï¼‰

### ğŸ”´ åš´é‡å•é¡Œï¼ˆP0ï¼‰

#### S1: Streaming æ™‚ raw JSON å¤–æ´©åˆ° UI
- **ç¾è±¡**ï¼šAI å›è¦†ä¸­å¤¾é›œ `"type": "tasks_extracted"` ç­‰ JSON ç‰‡æ®µ
- **æ ¹å› **ï¼š`InputArea.tsx:253-255` â€” æ‰€æœ‰ `content` type äº‹ä»¶éƒ½ç´¯ç©åˆ° `fullContent`ï¼Œä½† GPT æœ‰æ™‚æœƒåœ¨ content ä¸­ç›´æ¥è¼¸å‡º JSONï¼ˆè€Œéé€é tool callï¼‰ï¼Œå°è‡´ `done` æ™‚ JSON æ¸…ç†é‚è¼¯ï¼ˆL316-340ï¼‰ç„¡æ³•æ­£ç¢ºè™•ç†æ‰€æœ‰é‚Šç•Œæƒ…æ³
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åœ¨ `done` handler åŠ å…¥æ›´åš´æ ¼çš„ JSON å‰é›¢ï¼šè‹¥ `fullContent` ä»¥ `{` é–‹é ­ä¸”å¯è¢« JSON.parseï¼Œç›´æ¥ä½¿ç”¨ `parsed.message`
  2. åœ¨ streaming éšæ®µåŠ å…¥ JSON åµæ¸¬ï¼šç•¶ `content` äº‹ä»¶é–‹å§‹è¼¸å‡º `{` æ™‚ï¼Œæš«å­˜åˆ°éš±è— buffer ä¸é¡¯ç¤ºçµ¦ç”¨æˆ¶
  3. å¢åŠ  fallbackï¼šè‹¥ `messageContent` ä»å« JSON çµæ§‹ï¼Œç”Ÿæˆå‹å–„æç¤ºæ–‡å­—

#### S2: æ’ç¨‹åŠŸèƒ½ Invalid time value å´©æ½°
- **ç¾è±¡**ï¼š`generateSmartSchedule` å›å‚³ `RangeError: Invalid time value`
- **æ ¹å› **ï¼š`conflictDetection.ts:113` â€” `new Date(task.startTime).toISOString()` åœ¨ `startTime` æ ¼å¼ç‚º `HH:MM:00`ï¼ˆç„¡æ—¥æœŸå‰ç¶´ï¼‰æ™‚æœƒç”¢ç”Ÿ Invalid Date
- **è§¸ç™¼è·¯å¾‘**ï¼š`scheduleAlgorithm.ts:474-478` å‚³å…¥ `startTime`/`endTime` åˆ° `checkScheduleConflicts`ï¼Œä½† `allocateFromSlot`ï¼ˆL130-149ï¼‰å›å‚³çš„æ˜¯ `${slot.date}T${formatTime}:00` æ ¼å¼ã€‚ç•¶ `slot.date` ç‚ºç©ºæˆ–æ ¼å¼ç•°å¸¸æ™‚ï¼ŒDate å»ºæ§‹å­å¤±æ•—
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åœ¨ `conflictDetection.ts:113` åŠ å…¥ Date æœ‰æ•ˆæ€§æª¢æŸ¥ï¼š`if (isNaN(date.getTime())) continue`
  2. åœ¨ `allocateFromSlot` é©—è­‰ `slot.date` éç©º
  3. åœ¨ `scheduleAlgorithm.ts:474` éæ¿¾æ‰ startTime ç„¡æ•ˆçš„ä»»å‹™å†å‚³å…¥

#### S3: Google Calendar Token Refresh å¤±æ•—
- **ç¾è±¡**ï¼š`Token refresh failed: Error: invalid_grant`
- **æ ¹å› **ï¼š`src/lib/google.ts:37` â€” refresh token éæœŸæˆ–å¤±æ•ˆ
- **å½±éŸ¿**ï¼šæ’ç¨‹æ™‚åªèƒ½å–å¾— 1 å€‹å¯ç”¨æ™‚æ®µï¼ˆfallbackï¼‰ï¼Œåš´é‡å½±éŸ¿æ’ç¨‹å“è³ª
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åœ¨ `getAvailableSlots` åŠ å…¥ token refresh å¤±æ•—çš„ graceful degradation
  2. ä½¿ç”¨ç”¨æˆ¶è¨­å®šçš„å·¥ä½œæ™‚é–“ä½œç‚º fallback slotsï¼ˆè€Œéåªå›å‚³ 1 å€‹ï¼‰
  3. åœ¨ UI æç¤ºç”¨æˆ¶éœ€è¦é‡æ–°æˆæ¬Š Google Calendar

#### S4: æ—¥æœŸå¹´ä»½éŒ¯èª¤ï¼ˆ2024 vs 2026ï¼‰
- **ç¾è±¡**ï¼šAI å›è¦†çš„ä»»å‹™æ—¥æœŸå¶çˆ¾å‡ºç¾ 2024 å¹´
- **æ ¹å› **ï¼š`openai.ts` ç³»çµ± prompt å·²åŠ å…¥å¹´ä»½è­¦å‘Šï¼ˆL351-366ï¼‰ï¼Œä½† GPT çš„ function calling åƒæ•¸æœ‰æ™‚ä»è¼¸å‡ºéŒ¯èª¤å¹´ä»½ã€‚`allocateFromSlot` ä½¿ç”¨ `new Date(slot.date + 'T' + ...)` æ™‚ä¸æœƒé¡å¤–é©—è­‰å¹´ä»½
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åœ¨ `extractAndScheduleTasks` å’Œ `generateSmartSchedule` çš„åƒæ•¸é©—è­‰ä¸­åŠ å…¥å¹´ä»½æª¢æŸ¥
  2. å° AI å›å‚³çš„æ—¥æœŸåƒæ•¸åš post-processingï¼šè‹¥å¹´ä»½ < ç•¶å‰å¹´ä»½ï¼Œè‡ªå‹•ä¿®æ­£
  3. åœ¨ function definition çš„ description ä¸­å†æ¬¡å¼·èª¿å¹´ä»½

---

### ğŸŸ¡ ä¸­ç­‰å•é¡Œï¼ˆP1ï¼‰

#### M1: Streaming æœŸé–“ç™¼é€è¨Šæ¯è¢«éœé»˜ä¸Ÿæ£„
- **ç¾è±¡**ï¼šAI æ­£åœ¨å›è¦†æ™‚ï¼Œç”¨æˆ¶ç™¼é€çš„æ–°è¨Šæ¯è¢«å¿½ç•¥
- **æ ¹å› **ï¼š`InputArea.tsx` çš„ `handleSend` åœ¨ `isStreaming` æ™‚æ²’æœ‰æ’éšŠæ©Ÿåˆ¶
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åŠ å…¥è¨Šæ¯ä½‡åˆ—ï¼šstreaming æ™‚æš«å­˜ç”¨æˆ¶è¨Šæ¯
  2. streaming çµæŸå¾Œè‡ªå‹•ç™¼é€ä½‡åˆ—ä¸­çš„è¨Šæ¯
  3. æˆ–è€…åœ¨ UI ä¸Šé¡¯ç¤ºã€ŒAI æ­£åœ¨å›è¦†ä¸­ï¼Œè«‹ç¨å€™ã€çš„æç¤ºä¸¦ç¦ç”¨é€å‡ºæŒ‰éˆ•

#### M2: éä»»å‹™å°è©±èª¤è§¸ Function Calling
- **ç¾è±¡**ï¼šæ™®é€šèŠå¤©ï¼ˆå¦‚ç‰¹æ®Šå­—å…ƒæ¸¬è©¦ï¼‰è¢« `isSchedulingRelated` åˆ¤å®šç‚ºæ’ç¨‹ç›¸é—œ
- **æ ¹å› **ï¼š`definitions.ts:342-373` â€” é—œéµå­—åŒ¹é…éæ–¼å¯¬é¬†ï¼Œä¾‹å¦‚ã€Œè¨ˆç•«ã€ã€Œå®‰æ’ã€ç­‰å¸¸ç”¨è©è§¸ç™¼ function calling
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. æé«˜è§¸ç™¼é–¾å€¼ï¼šè¦æ±‚è‡³å°‘åŒ¹é… 2 å€‹é—œéµå­—ï¼Œæˆ–æ­é…ä¸Šä¸‹æ–‡åˆ¤æ–·
  2. å°‡ `isSchedulingRelated` æ”¹ç‚ºè©•åˆ†åˆ¶ï¼ˆscoringï¼‰ï¼Œåªåœ¨åˆ†æ•¸è¶…éé–¾å€¼æ™‚å•Ÿç”¨
  3. åŠ å…¥è² é¢é—œéµå­—éæ¿¾ï¼ˆå¦‚ç´”å•å€™ã€æ¸¬è©¦ã€debugï¼‰

#### M3: ä»»å‹™é¸æ“‡ UI ç¼ºå°‘æ˜ç¢ºç¢ºèªæŒ‰éˆ•
- **ç¾è±¡**ï¼šèƒå–çš„ä»»å‹™åˆ—è¡¨ç„¡æ³•ä¸€éµç¢ºèªæˆ–å–æ¶ˆ
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åœ¨ä»»å‹™å¡ç‰‡å€å¡ŠåŠ å…¥ã€Œå…¨éƒ¨åŠ å…¥ã€å’Œã€Œå–æ¶ˆã€æŒ‰éˆ•
  2. æ”¯æ´å‹¾é¸å€‹åˆ¥ä»»å‹™çš„æ‰¹é‡æ“ä½œ

#### M4: AI åå¥½å­¸ç¿’å¾Œæ²’æœ‰ç”¨æˆ¶å›é¥‹
- **ç¾è±¡**ï¼š`preference_learned` äº‹ä»¶è¢«æ¥æ”¶ä½†æ²’æœ‰ UI åé¥‹
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼š
  1. åŠ å…¥ toast é€šçŸ¥ï¼šã€Œå·²å­¸ç¿’æ‚¨çš„æ’ç¨‹åå¥½ã€
  2. åœ¨è¨­å®šé é¢é¡¯ç¤ºå·²å­¸ç¿’çš„åå¥½åˆ—è¡¨

---

### ğŸŸ¢ é«”é©—æ”¹å–„ï¼ˆP2ï¼‰

#### L1: Markdown è¡¨æ ¼æ¸²æŸ“ä¸ä½³
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼šç¢ºèª ChatWindow çš„ markdown æ¸²æŸ“å™¨æ”¯æ´ GFM è¡¨æ ¼

#### L2: æœƒè­°è¨˜éŒ„å¡ç‰‡æŒçºŒæ™‚é–“éé•·
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼šåŠ å…¥è‡ªå‹•éš±è—è¨ˆæ™‚å™¨æˆ–ã€Œæ”¶èµ·ã€æŒ‰éˆ•

#### L3: Token ç”¨é‡é¡¯ç¤ºä¸å‹å–„
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼šæ”¹ç”¨é€²åº¦æ¢æˆ–ã€Œå·²ä½¿ç”¨ X%ã€æ ¼å¼

#### L4: å°é•·æ–‡é€å­—ç¨¿çš„è™•ç†èƒ½åŠ›ä¸è¶³
- **ä¿®å¾©æ–¹æ¡ˆ**ï¼šåŠ å…¥è‡ªå‹•åˆ†æ®µè™•ç†é‚è¼¯ï¼Œè¶…éä¸€å®šé•·åº¦æ™‚åˆ†æ‰¹é€ API

---

## å¯¦æ–½è¨ˆç•«

### Phase 1ï¼šä¿®å¾©å´©æ½°å’Œæ•¸æ“šéŒ¯èª¤ï¼ˆ1-2 å¤©ï¼‰
| é …ç›® | æª”æ¡ˆ | é ä¼°æ™‚é–“ |
|------|------|---------|
| S2: Invalid time value | `conflictDetection.ts`, `scheduleAlgorithm.ts` | 30 min |
| S3: Token refresh fallback | `getAvailableSlots.ts`, `google.ts` | 1 hr |
| S4: å¹´ä»½ä¿®æ­£ | `scheduleAlgorithm.ts`, `extractAndScheduleTasks.ts` | 30 min |

### Phase 2ï¼šä¿®å¾© UI é¡¯ç¤ºå•é¡Œï¼ˆ1 å¤©ï¼‰
| é …ç›® | æª”æ¡ˆ | é ä¼°æ™‚é–“ |
|------|------|---------|
| S1: JSON å¤–æ´©ä¿®å¾© | `InputArea.tsx` | 1 hr |
| M1: Streaming æœŸé–“è¨Šæ¯è™•ç† | `InputArea.tsx` | 30 min |
| M4: åå¥½å­¸ç¿’ toast | `InputArea.tsx` | 15 min |

### Phase 3ï¼šæå‡æ™ºæ…§åº¦ï¼ˆ1 å¤©ï¼‰
| é …ç›® | æª”æ¡ˆ | é ä¼°æ™‚é–“ |
|------|------|---------|
| M2: Function calling è§¸ç™¼å„ªåŒ– | `definitions.ts` | 1 hr |
| M3: ä»»å‹™ç¢ºèª UI | `ChatWindow.tsx` | 1 hr |

### Phase 4ï¼šé«”é©—æ‰“ç£¨ï¼ˆ0.5 å¤©ï¼‰
| é …ç›® | æª”æ¡ˆ | é ä¼°æ™‚é–“ |
|------|------|---------|
| L1-L4 | å„ç›¸é—œå…ƒä»¶ | 2 hr |

---

## å„ªå…ˆå»ºè­°

**ç«‹å³ä¿®å¾©**ï¼šS2ï¼ˆæ’ç¨‹å´©æ½°ï¼‰â†’ S1ï¼ˆJSON å¤–æ´©ï¼‰â†’ S3ï¼ˆGoogle Calendar fallbackï¼‰

é€™ä¸‰å€‹å•é¡Œç›´æ¥å°è‡´æ ¸å¿ƒåŠŸèƒ½ä¸å¯ç”¨ï¼Œä¿®å¾©å¾Œç”¨æˆ¶é«”é©—æœƒæœ‰é¡¯è‘—æå‡ã€‚
