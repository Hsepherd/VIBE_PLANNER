# Story S-007: UI - 排程預覽面板

> **Story ID**: S-007
> **Epic**: EPIC-001 AI 智慧排程 Phase 1
> **估計點數**: 8
> **優先級**: P1
> **依賴**: S-006

---

## User Story

**作為** 使用者
**我想要** 看到 AI 建議的排程預覽並能調整
**以便** 確認後才將任務排入行事曆

---

## 驗收標準 (Acceptance Criteria)

### AC1: 顯示排程預覽
```gherkin
Given AI 產生排程建議
When 顯示排程預覽面板
Then 顯示每個任務的建議時段
And 以時間軸形式呈現
And 顯示任務優先級標示
```

### AC2: 拖拉調整時間
```gherkin
Given 排程預覽中有一個任務 09:00-10:30
When 使用者拖拉調整到 10:00-11:30
Then 時間更新為 10:00-11:30
And 檢查是否與其他任務衝突
And 如有衝突顯示警告
```

### AC3: 移除任務
```gherkin
Given 排程預覽中有 5 個任務
When 使用者點擊任務的「移除」按鈕
Then 該任務從本次排程中移除
And 不刪除原任務
And 可用時間重新計算
```

### AC4: 確認排程
```gherkin
Given 使用者調整完排程
When 點擊「確認排程」
Then 所有任務的 start_date 和 end_date 更新
And 任務同步到行事曆頁面
And 顯示成功訊息
```

### AC5: 重新排程
```gherkin
Given 排程預覽顯示中
When 點擊「重新排程」
Then 清除目前預覽
And AI 重新計算排程
And 顯示新的建議
```

### AC6: 警告顯示
```gherkin
Given 有任務無法排入
When 顯示排程預覽
Then 顯示警告區塊
And 列出未排入的任務和原因
And 提供建議（如：延後、拆分）
```

---

## UI 設計

### 排程預覽面板

```
┌─────────────────────────────────────────────────────────┐
│ 📅 排程預覽 - 2026/01/19 (一)              [重新排程] X │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  09:00 ┬─────────────────────────────────┐              │
│        │ 🔴 小課程大綱                    │ [⋮]         │
│        │    預估 1.5 小時                 │              │
│  10:30 ┴─────────────────────────────────┘              │
│                                                         │
│  10:30 ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ 休息            │
│                                                         │
│  11:00 ┬─────────────────────────────────┐              │
│        │ 🟡 審核老師影片                  │ [⋮]         │
│        │    預估 1 小時                   │              │
│  12:00 ┴─────────────────────────────────┘              │
│                                                         │
│  12:00 ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ 午餐            │
│                                                         │
│  14:00 ┬─────────────────────────────────┐              │
│        │ 🔴 準備週會簡報                  │ [⋮]         │
│        │    預估 1.5 小時 · 明天截止      │              │
│  15:30 ┴─────────────────────────────────┘              │
│                                                         │
│  15:30 ┬────────────────┐┬───────────────┐              │
│        │ 🟢 回覆郵件     ││ ⏳ 測試部署    │              │
│  16:00 ┴────────────────┘│   (背景執行)   │              │
│  16:30                    ┴───────────────┘              │
│                                                         │
├─────────────────────────────────────────────────────────┤
│ ⚠️ 1 個任務無法排入                                      │
│    • 「產品規劃」(3hr) - 今日可用時間不足                │
│    建議：延後到明天                                      │
├─────────────────────────────────────────────────────────┤
│                    [取消]    [確認排程到行事曆]          │
└─────────────────────────────────────────────────────────┘
```

### 任務卡片 Menu

```
┌─────────────┐
│ 調整時間     │
│ 移除此任務   │
│ 標記為背景   │
└─────────────┘
```

### 調整時間 Modal

```
┌─────────────────────────────────┐
│ 調整時間 - 小課程大綱            │
├─────────────────────────────────┤
│                                 │
│  開始時間: [09:00 ▾]            │
│  結束時間: [10:30 ▾]            │
│                                 │
│  預估時間: 1.5 小時              │
│                                 │
│  ⚠️ 與「審核影片」時間重疊       │
│                                 │
├─────────────────────────────────┤
│         [取消]    [確認]         │
└─────────────────────────────────┘
```

---

## 元件結構

```
components/
└── scheduling/
    ├── SchedulePreviewPanel.tsx    # 主面板
    ├── ScheduleTimeline.tsx        # 時間軸
    ├── ScheduleTaskCard.tsx        # 任務卡片
    ├── ScheduleWarnings.tsx        # 警告區塊
    ├── TimeAdjustDialog.tsx        # 調整時間對話框
    └── hooks/
        └── useSchedulePreview.ts   # 狀態管理
```

---

## 技術任務

- [ ] 建立 `SchedulePreviewPanel` 主元件
- [ ] 建立 `ScheduleTimeline` 時間軸元件
- [ ] 建立 `ScheduleTaskCard` 任務卡片（支援拖拉）
- [ ] 建立 `TimeAdjustDialog` 時間調整對話框
- [ ] 建立 `ScheduleWarnings` 警告區塊
- [ ] 實作拖拉調整功能 (react-dnd 或類似)
- [ ] 實作衝突檢測
- [ ] 實作確認排程 API 呼叫
- [ ] 實作重新排程功能
- [ ] 響應式設計（Mobile 適配）

---

## 狀態管理

```typescript
interface SchedulePreviewState {
  isOpen: boolean;
  isLoading: boolean;
  schedules: Schedule[];
  unscheduled: UnscheduledTask[];
  warnings: string[];
  selectedDate: Date;
  hasChanges: boolean;
}

interface Schedule {
  taskId: string;
  taskTitle: string;
  priority: 'high' | 'medium' | 'low';
  taskType: 'focus' | 'background';
  startTime: Date;
  endTime: Date;
  estimatedMinutes: number;
  dueDate?: Date;
  isModified: boolean;
}
```

---

## API 呼叫

### 確認排程

```typescript
// POST /api/schedule/confirm
const response = await fetch('/api/schedule/confirm', {
  method: 'POST',
  body: JSON.stringify({
    schedules: [
      {
        taskId: 'xxx',
        startTime: '2026-01-19T09:00:00',
        endTime: '2026-01-19T10:30:00',
      },
      // ...
    ],
  }),
});
```

---

## 測試案例

| # | 測試 | 預期結果 |
|---|------|----------|
| 1 | 顯示排程預覽 | 正確顯示所有任務 |
| 2 | 拖拉調整時間 | 時間更新 |
| 3 | 拖拉造成衝突 | 顯示警告 |
| 4 | 移除任務 | 任務從預覽移除 |
| 5 | 確認排程 | 任務更新成功 |
| 6 | 重新排程 | 重新計算 |
| 7 | Mobile 操作 | 觸控友善 |

---

## Definition of Done

- [ ] 排程預覽面板正常顯示
- [ ] 拖拉調整功能正常
- [ ] 時間調整對話框正常
- [ ] 確認排程功能正常
- [ ] 重新排程功能正常
- [ ] 警告區塊正常顯示
- [ ] Mobile 響應式正常
- [ ] 測試案例通過
