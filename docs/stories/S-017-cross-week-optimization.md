# Story S-017: è·¨é€±æ’ç¨‹å„ªåŒ–

> **Story ID**: S-017
> **Epic**: EPIC-003 AI æ™ºæ…§æ’ç¨‹ Phase 3
> **ä¼°è¨ˆé»æ•¸**: 8
> **å„ªå…ˆç´š**: P3
> **ä¾è³´**: EPIC-002 å®Œæˆ

---

## User Story

**ä½œç‚º** ä½¿ç”¨è€…
**æˆ‘æƒ³è¦** AI èƒ½æ™ºæ…§åœ°å°‡ä»»å‹™åˆ†é…åˆ°æœªä¾†å¹¾é€±
**ä»¥ä¾¿** å¹³è¡¡æ¯å¤©çš„å·¥ä½œé‡ï¼Œé¿å…æŸå¤©éè¼‰

---

## é©—æ”¶æ¨™æº– (Acceptance Criteria)

### AC1: è·¨é€±æ’ç¨‹
```gherkin
Given ä½¿ç”¨è€…æœ‰ 20 å€‹ä»»å‹™ï¼Œç¸½éœ€æ™‚ 40 å°æ™‚
And æ¯å¤©å¯ç”¨æ™‚é–“ 6 å°æ™‚
When ä½¿ç”¨è€…èªªã€Œå¹«æˆ‘æ’æ¥ä¸‹ä¾†å…©é€±ã€
Then AI å°‡ä»»å‹™åˆ†é…åˆ°æœªä¾†å…©é€±
And æ¯å¤©å·¥ä½œé‡å¤§è‡´å¹³è¡¡
```

### AC2: å·¥ä½œé‡å¹³è¡¡
```gherkin
Given è·¨é€±æ’ç¨‹
When é¡¯ç¤ºçµæœ
Then æ¯å¤©å·¥ä½œé‡å·®ç•°ä¸è¶…é 30%
And é¿å…æŸå¤© 10 å°æ™‚ã€å¦ä¸€å¤© 2 å°æ™‚çš„æƒ…æ³
```

### AC3: æˆªæ­¢æ—¥å„ªå…ˆ
```gherkin
Given ä»»å‹™ A æˆªæ­¢æ—¥æ˜¯ä¸‹é€±ä¸‰
And ä»»å‹™ B æˆªæ­¢æ—¥æ˜¯ä¸‹ä¸‹é€±
When AI æ’ç¨‹
Then ä»»å‹™ A æ’åœ¨ä¸‹é€±ä¸‰ä¹‹å‰
And ä»»å‹™ B å¯ä»¥æ’åœ¨ä¸‹é€±ä¸‰ä¹‹å¾Œ
```

### AC4: å·¥ä½œé‡é è­¦
```gherkin
Given æ’ç¨‹çµæœé¡¯ç¤ºä¸‹é€±ä¸‰å·¥ä½œé‡è¶…é 10 å°æ™‚
When é¡¯ç¤ºæ’ç¨‹
Then é¡¯ç¤ºé è­¦ã€Œä¸‹é€±ä¸‰å·¥ä½œé‡éé‡ã€
And å»ºè­°ã€Œè€ƒæ…®å°‡éƒ¨åˆ†ä»»å‹™ç§»åˆ°é€±äºŒæˆ–é€±å››ã€
```

### AC5: é€±æœ«è™•ç†
```gherkin
Given ä½¿ç”¨è€…è¨­å®šé€±å…­æ—¥ä¸å·¥ä½œ
When AI æ’ç¨‹
Then é€±å…­æ—¥ä¸æ’ä»»å‹™
And å¦‚æœæˆªæ­¢æ—¥æ˜¯é€±æœ«ï¼Œæå‰åˆ°é€±äº”
```

### AC6: é•·æœŸè¦–åœ–
```gherkin
Given è·¨é€±æ’ç¨‹å®Œæˆ
When é¡¯ç¤ºçµæœ
Then æä¾›é€±è¦–åœ–å’Œå·¥ä½œé‡åœ–è¡¨
And å¯ä»¥çœ‹åˆ°æ¯é€±ç¸½æ™‚æ•¸
```

---

## UI è¨­è¨ˆ

### è·¨é€±æ’ç¨‹é è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… å…©é€±æ’ç¨‹é è¦½                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ æœ¬é€± (01/20 - 01/26)                                    â”‚
â”‚ â”œâ”€â”€ ä¸€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5.5hr                            â”‚
â”‚ â”œâ”€â”€ äºŒ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 6hr                              â”‚
â”‚ â”œâ”€â”€ ä¸‰ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 7hr âš ï¸ éé‡                     â”‚
â”‚ â”œâ”€â”€ å›› â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5hr                              â”‚
â”‚ â”œâ”€â”€ äº” â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5.5hr                            â”‚
â”‚ â”œâ”€â”€ å…­ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¼‘æ¯                              â”‚
â”‚ â””â”€â”€ æ—¥ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¼‘æ¯                              â”‚
â”‚                                                         â”‚
â”‚ ä¸‹é€± (01/27 - 02/02)                                    â”‚
â”‚ â”œâ”€â”€ ä¸€ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5hr                              â”‚
â”‚ â”œâ”€â”€ äºŒ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5.5hr                            â”‚
â”‚ â”œâ”€â”€ ä¸‰ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 5hr                              â”‚
â”‚ â”œâ”€â”€ å›› â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 4hr                              â”‚
â”‚ â”œâ”€â”€ äº” â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 3hr                              â”‚
â”‚ â”œâ”€â”€ å…­ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¼‘æ¯                              â”‚
â”‚ â””â”€â”€ æ—¥ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ ä¼‘æ¯                              â”‚
â”‚                                                         â”‚
â”‚ ğŸ“Š çµ±è¨ˆ                                                  â”‚
â”‚ â€¢ æœ¬é€±ç¸½è¨ˆ: 35 å°æ™‚ (20 å€‹ä»»å‹™)                          â”‚
â”‚ â€¢ ä¸‹é€±ç¸½è¨ˆ: 22.5 å°æ™‚ (12 å€‹ä»»å‹™)                       â”‚
â”‚ â€¢ ç„¡æ³•æ’å…¥: 2 å€‹ä»»å‹™ (æ™‚é–“ä¸è¶³)                         â”‚
â”‚                                                         â”‚
â”‚ âš ï¸ é€±ä¸‰å·¥ä½œé‡éé‡ (7hr)ï¼Œå»ºè­°èª¿æ•´                        â”‚
â”‚                                                         â”‚
â”‚                [èª¿æ•´]  [ç¢ºèªæ’ç¨‹]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œé‡åœ–è¡¨

```
å·¥ä½œé‡ (å°æ™‚)
   â†‘
 8 â”‚                    âš ï¸
 7 â”‚              â–ˆâ–ˆâ–ˆâ–ˆ
 6 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
 5 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
 4 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
 3 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
 2 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
 1 â”‚  â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ  â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ â–ˆâ–ˆâ–ˆâ–ˆ
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ æ—¥æœŸ
     ä¸€   äºŒ   ä¸‰   å››   äº”   ä¸€   äºŒ   ä¸‰   å››   äº”
     â””â”€â”€â”€â”€â”€ æœ¬é€± â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€ ä¸‹é€± â”€â”€â”€â”€â”€â”˜
```

---

## æ’ç¨‹æ¼”ç®—æ³•

```typescript
interface CrossWeekScheduleInput {
  tasks: Task[];
  startDate: Date;
  endDate: Date;
  workingDays: number[];  // [1,2,3,4,5] = é€±ä¸€åˆ°é€±äº”
  dailyWorkHours: number; // ä¾‹å¦‚ 6
  targetBalance: number;  // ç›®æ¨™å¹³è¡¡åº¦ï¼Œä¾‹å¦‚ 0.3 = 30% å·®ç•°å…§
}

function scheduleCrossWeek(input: CrossWeekScheduleInput): CrossWeekResult {
  const { tasks, startDate, endDate, workingDays, dailyWorkHours, targetBalance } = input;

  // 1. è¨ˆç®—ç¸½å¯ç”¨æ™‚é–“
  const workingDaysCount = countWorkingDays(startDate, endDate, workingDays);
  const totalAvailableHours = workingDaysCount * dailyWorkHours;
  const totalTaskHours = tasks.reduce((sum, t) => sum + t.estimatedMinutes / 60, 0);

  // 2. è¨ˆç®—æ¯æ—¥ç›®æ¨™å·¥æ™‚
  const avgDailyHours = totalTaskHours / workingDaysCount;

  // 3. æŒ‰æˆªæ­¢æ—¥åˆ†çµ„ä»»å‹™
  const tasksByDeadline = groupTasksByDeadline(tasks);

  // 4. è²ªå©ªåˆ†é…ï¼ˆè€ƒæ…®æˆªæ­¢æ—¥å’Œå¹³è¡¡ï¼‰
  const dailySchedules: Map<string, Schedule[]> = new Map();

  for (const [deadline, deadlineTasks] of tasksByDeadline) {
    // å¿…é ˆåœ¨æˆªæ­¢æ—¥å‰å®Œæˆ
    const availableDays = getWorkingDaysBefore(deadline, workingDays);

    for (const task of deadlineTasks) {
      // æ‰¾åˆ°å·¥ä½œé‡æœ€å°‘çš„ä¸€å¤©ï¼ˆåœ¨æˆªæ­¢æ—¥å‰ï¼‰
      const targetDay = findLeastLoadedDay(dailySchedules, availableDays, avgDailyHours);

      if (targetDay) {
        addTaskToDay(dailySchedules, targetDay, task);
      } else {
        unscheduled.push(task);
      }
    }
  }

  // 5. å¹³è¡¡å„ªåŒ–ï¼ˆè²ªå©ªèª¿æ•´ï¼‰
  optimizeBalance(dailySchedules, targetBalance);

  // 6. ç”¢ç”Ÿé è­¦
  const warnings = generateWorkloadWarnings(dailySchedules, dailyWorkHours);

  return {
    dailySchedules,
    warnings,
    stats: {
      totalHours: totalTaskHours,
      avgDailyHours,
      maxDailyHours: getMaxDailyHours(dailySchedules),
      minDailyHours: getMinDailyHours(dailySchedules),
    },
  };
}

function optimizeBalance(
  schedules: Map<string, Schedule[]>,
  targetBalance: number
): void {
  let improved = true;
  let iterations = 0;
  const maxIterations = 100;

  while (improved && iterations < maxIterations) {
    improved = false;
    iterations++;

    // æ‰¾åˆ°æœ€é‡å’Œæœ€è¼•çš„æ—¥å­
    const heaviestDay = findHeaviestDay(schedules);
    const lightestDay = findLightestDay(schedules);

    const heavyLoad = getDayLoad(schedules, heaviestDay);
    const lightLoad = getDayLoad(schedules, lightestDay);

    // å¦‚æœå·®ç•°è¶…éç›®æ¨™ï¼Œå˜—è©¦ç§»å‹•ä»»å‹™
    if ((heavyLoad - lightLoad) / heavyLoad > targetBalance) {
      const movedTask = tryMoveTask(schedules, heaviestDay, lightestDay);
      if (movedTask) {
        improved = true;
      }
    }
  }
}
```

---

## è¨­å®šé …ç›®

```typescript
interface WorkScheduleSettings {
  workingDays: number[];           // å·¥ä½œæ—¥ [1,2,3,4,5]
  dailyWorkHours: number;          // æ¯æ—¥å·¥æ™‚ 6
  preferredStartTime: string;      // åå¥½é–‹å§‹æ™‚é–“ "09:00"
  preferredEndTime: string;        // åå¥½çµæŸæ™‚é–“ "18:00"
  lunchBreakStart?: string;        // åˆä¼‘é–‹å§‹ "12:00"
  lunchBreakEnd?: string;          // åˆä¼‘çµæŸ "13:00"
  maxOverloadPercent: number;      // æœ€å¤§è¶…è¼‰ç™¾åˆ†æ¯” 30
}
```

---

## æŠ€è¡“ä»»å‹™

- [ ] å¯¦ä½œè·¨é€±æ’ç¨‹æ¼”ç®—æ³•
- [ ] å¯¦ä½œå·¥ä½œé‡å¹³è¡¡å„ªåŒ–
- [ ] æˆªæ­¢æ—¥åˆ†çµ„é‚è¼¯
- [ ] å·¥ä½œæ—¥è¨­å®šï¼ˆæ’é™¤é€±æœ«ï¼‰
- [ ] å·¥ä½œé‡é è­¦é‚è¼¯
- [ ] è·¨é€±é è¦½ UI
- [ ] å·¥ä½œé‡åœ–è¡¨
- [ ] é€±è¦–åœ–åˆ‡æ›
- [ ] API: è·¨é€±æ’ç¨‹ç«¯é»

---

## API ç«¯é»

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| POST | `/api/schedule/cross-week` | è·¨é€±æ’ç¨‹ |

**Request**
```json
{
  "startDate": "2026-01-20",
  "endDate": "2026-02-02",
  "workingDays": [1, 2, 3, 4, 5],
  "dailyWorkHours": 6
}
```

---

## æ¸¬è©¦æ¡ˆä¾‹

| # | æ¸¬è©¦ | é æœŸçµæœ |
|---|------|----------|
| 1 | è·¨é€±æ’ç¨‹ | ä»»å‹™åˆ†é…åˆ°å…©é€± |
| 2 | å·¥ä½œé‡å¹³è¡¡ | æ¯å¤©å·®ç•° < 30% |
| 3 | æˆªæ­¢æ—¥å„ªå…ˆ | æˆªæ­¢è¿‘çš„å…ˆæ’ |
| 4 | é€±æœ«æ’é™¤ | é€±æœ«ç„¡ä»»å‹™ |
| 5 | å·¥ä½œé‡é è­¦ | è¶…è¼‰æ™‚é¡¯ç¤ºè­¦å‘Š |
| 6 | æ™‚é–“ä¸è¶³ | é¡¯ç¤ºç„¡æ³•æ’å…¥çš„ä»»å‹™ |

---

## Definition of Done

- [ ] è·¨é€±æ’ç¨‹é‚è¼¯æ­£ç¢º
- [ ] å·¥ä½œé‡å¹³è¡¡æ¼”ç®—æ³•æ­£ç¢º
- [ ] æˆªæ­¢æ—¥è™•ç†æ­£ç¢º
- [ ] é€±æœ«æ’é™¤æ­£ç¢º
- [ ] é è­¦åŠŸèƒ½æ­£å¸¸
- [ ] UI åœ–è¡¨é¡¯ç¤ºæ­£ç¢º
- [ ] æ¸¬è©¦æ¡ˆä¾‹é€šé
