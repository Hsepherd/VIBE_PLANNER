# Story S-013: AI è‡ªå‹•åˆ¤æ–·ä»»å‹™ä¾è³´

> **Story ID**: S-013
> **Epic**: EPIC-002 AI æ™ºæ…§æ’ç¨‹ Phase 2
> **ä¼°è¨ˆé»æ•¸**: 5
> **å„ªå…ˆç´š**: P2
> **ä¾è³´**: EPIC-001 å®Œæˆ

---

## User Story

**ä½œç‚º** ä½¿ç”¨è€…
**æˆ‘æƒ³è¦** AI è‡ªå‹•å¾ä»»å‹™æè¿°ä¸­è­˜åˆ¥ä¾è³´é—œä¿‚
**ä»¥ä¾¿** æ’ç¨‹æ™‚è‡ªå‹•è€ƒæ…®ä»»å‹™çš„å…ˆå¾Œé †åº

---

## é©—æ”¶æ¨™æº– (Acceptance Criteria)

### AC1: è­˜åˆ¥ä¾è³´é—œéµå­—
```gherkin
Given ä»»å‹™æè¿°åŒ…å«ã€Œç­‰è¨­è¨ˆç¨¿å®Œæˆå¾Œã€
When AI åˆ†æä»»å‹™
Then è­˜åˆ¥å‡ºå¯èƒ½çš„ä¾è³´ä»»å‹™ã€Œè¨­è¨ˆç¨¿ã€
And å»ºè­°å»ºç«‹ä¾è³´é—œä¿‚
```

### AC2: å»ºè­°ç¢ºèª
```gherkin
Given AI è­˜åˆ¥å‡ºä¾è³´é—œä¿‚
When é¡¯ç¤ºçµ¦ä½¿ç”¨è€…
Then é¡¯ç¤ºã€Œé€™å€‹ä»»å‹™æ˜¯å¦ä¾è³´ XXXï¼Ÿã€
And ä½¿ç”¨è€…å¯ç¢ºèªæˆ–æ‹’çµ•
And ç¢ºèªå¾Œå»ºç«‹ä¾è³´é—œä¿‚
```

### AC3: æ’ç¨‹æ™‚è€ƒæ…®ä¾è³´
```gherkin
Given ä»»å‹™ B ä¾è³´ä»»å‹™ A
When AI æ’ç¨‹
Then ä»»å‹™ A å¿…é ˆæ’åœ¨ä»»å‹™ B ä¹‹å‰
And ä»»å‹™ A çµæŸæ™‚é–“ <= ä»»å‹™ B é–‹å§‹æ™‚é–“
```

### AC4: æ‰‹å‹•è¨­å®šä¾è³´
```gherkin
Given ä½¿ç”¨è€…æƒ³æ‰‹å‹•è¨­å®šä¾è³´
When åœ¨ä»»å‹™è©³æƒ…é¸æ“‡ã€Œä¾è³´ä»»å‹™ã€
Then é¡¯ç¤ºå¯é¸ä»»å‹™åˆ—è¡¨
And å¯ä»¥é¸æ“‡ä¸€æˆ–å¤šå€‹å‰ç½®ä»»å‹™
```

### AC5: ä¾è³´è¦–è¦ºåŒ–
```gherkin
Given ä»»å‹™æœ‰ä¾è³´é—œä¿‚
When é¡¯ç¤ºä»»å‹™åˆ—è¡¨æˆ–æ’ç¨‹
Then é¡¯ç¤ºä¾è³´é€£ç·šæˆ–æ¨™ç¤º
And å¯ä»¥æŸ¥çœ‹å®Œæ•´ä¾è³´éˆ
```

---

## ä¾è³´è­˜åˆ¥é‚è¼¯

### é—œéµå­—æ¨¡å¼

```typescript
const DEPENDENCY_PATTERNS = [
  // ä¸­æ–‡
  { pattern: /ç­‰[ã€Œã€]?(.+?)[ã€ã€]?å®Œæˆ/, type: 'after' },
  { pattern: /[ã€Œã€](.+?)[ã€ã€]å®Œæˆå¾Œ/, type: 'after' },
  { pattern: /éœ€è¦å…ˆ[ã€Œã€]?(.+?)[ã€ã€]?/, type: 'after' },
  { pattern: /ä¾è³´[ã€Œã€]?(.+?)[ã€ã€]?/, type: 'after' },
  { pattern: /å‰ç½®.*[ã€Œã€](.+?)[ã€ã€]/, type: 'after' },
  { pattern: /(.+?)ä¹‹å¾Œæ‰èƒ½/, type: 'after' },

  // è‹±æ–‡
  { pattern: /after[:\s]+["']?(.+?)["']?/i, type: 'after' },
  { pattern: /depends on[:\s]+["']?(.+?)["']?/i, type: 'after' },
  { pattern: /blocked by[:\s]+["']?(.+?)["']?/i, type: 'after' },
  { pattern: /waiting for[:\s]+["']?(.+?)["']?/i, type: 'after' },
];
```

### AI è¼”åŠ©è­˜åˆ¥

```typescript
const DEPENDENCY_ANALYSIS_PROMPT = `
åˆ†æä»¥ä¸‹ä»»å‹™ï¼Œè­˜åˆ¥å¯èƒ½çš„ä¾è³´é—œä¿‚ã€‚

ä»»å‹™æ¨™é¡Œï¼š{title}
ä»»å‹™æè¿°ï¼š{description}

ç¾æœ‰ä»»å‹™åˆ—è¡¨ï¼š
{existingTasks}

è«‹å›å‚³ JSONï¼š
{
  "hasDependency": true/false,
  "dependsOn": [
    {
      "taskTitle": "åŒ¹é…çš„ä»»å‹™æ¨™é¡Œ",
      "confidence": "high/medium/low",
      "reason": "è­˜åˆ¥åŸå› "
    }
  ]
}

åªå›å ±æœ‰æ˜ç¢ºä¾è³´é—œä¿‚çš„æƒ…æ³ï¼Œä¸è¦çŒœæ¸¬ã€‚
`;
```

---

## è³‡æ–™åº«è¨­è¨ˆ

```sql
-- ä»»å‹™ä¾è³´è¡¨
CREATE TABLE task_dependencies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  depends_on_task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,

  -- ä¾è³´é¡å‹
  dependency_type VARCHAR(20) DEFAULT 'finish_to_start',
  -- finish_to_start: A å®Œæˆå¾Œ B æ‰èƒ½é–‹å§‹
  -- start_to_start: A é–‹å§‹å¾Œ B æ‰èƒ½é–‹å§‹
  -- finish_to_finish: A å®Œæˆå¾Œ B æ‰èƒ½å®Œæˆ

  -- æ˜¯å¦ç‚º AI å»ºè­°
  is_ai_suggested BOOLEAN DEFAULT false,
  ai_confidence VARCHAR(10),  -- high/medium/low

  created_at TIMESTAMP DEFAULT NOW(),

  -- é˜²æ­¢é‡è¤‡ä¾è³´
  UNIQUE(task_id, depends_on_task_id),

  -- é˜²æ­¢è‡ªæˆ‘ä¾è³´
  CHECK (task_id != depends_on_task_id)
);

-- ç´¢å¼•
CREATE INDEX idx_task_dependencies_task_id ON task_dependencies(task_id);
CREATE INDEX idx_task_dependencies_depends_on ON task_dependencies(depends_on_task_id);

-- RLSï¼ˆé€šé tasks è¡¨çš„ RLS é–“æ¥æ§åˆ¶ï¼‰
```

---

## UI è¨­è¨ˆ

### AI å»ºè­°ä¾è³´

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¡ AI ç™¼ç¾å¯èƒ½çš„ä¾è³´é—œä¿‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ä»»å‹™ï¼šã€Œé–‹ç™¼ç™»å…¥åŠŸèƒ½ã€                                   â”‚
â”‚ æè¿°ä¸­æåˆ°ï¼šã€Œç­‰è¨­è¨ˆç¨¿å®Œæˆå¾Œé–‹å§‹ã€                        â”‚
â”‚                                                         â”‚
â”‚ å»ºè­°ä¾è³´æ–¼ï¼š                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ ç™»å…¥é é¢è¨­è¨ˆç¨¿  (ä¿¡å¿ƒåº¦: é«˜)                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚              [å¿½ç•¥]  [ç¢ºèªä¾è³´]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»»å‹™è©³æƒ… - ä¾è³´å€å¡Š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”— ä¾è³´é—œä¿‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ å‰ç½®ä»»å‹™ï¼ˆå¿…é ˆå…ˆå®Œæˆï¼‰ï¼š                                  â”‚
â”‚ â”œâ”€ âœ… ç™»å…¥é é¢è¨­è¨ˆç¨¿ (å·²å®Œæˆ)                            â”‚
â”‚ â””â”€ â³ API è¨­è¨ˆæ–‡ä»¶ (é€²è¡Œä¸­)                             â”‚
â”‚                                                         â”‚
â”‚ å¾ŒçºŒä»»å‹™ï¼ˆç­‰å¾…æ­¤ä»»å‹™ï¼‰ï¼š                                  â”‚
â”‚ â””â”€ ğŸ“‹ æ•´åˆæ¸¬è©¦                                          â”‚
â”‚                                                         â”‚
â”‚ [+ æ–°å¢ä¾è³´]                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é¸æ“‡ä¾è³´ä»»å‹™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é¸æ“‡å‰ç½®ä»»å‹™                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” [æœå°‹ä»»å‹™...]                                        â”‚
â”‚                                                         â”‚
â”‚ å»ºè­°çš„ä»»å‹™ï¼š                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ ç™»å…¥é é¢è¨­è¨ˆç¨¿                                     â”‚ â”‚
â”‚ â”‚ â˜ API è¨­è¨ˆæ–‡ä»¶                                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚ å…¶ä»–ä»»å‹™ï¼š                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â˜ æº–å‚™é€±æœƒç°¡å ±                                       â”‚ â”‚
â”‚ â”‚ â˜ å¯©æ ¸è€å¸«å½±ç‰‡                                       â”‚ â”‚
â”‚ â”‚ â˜ ...                                                â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚              [å–æ¶ˆ]  [ç¢ºèª]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•´åˆæ’ç¨‹æ¼”ç®—æ³•

```typescript
function scheduleWithDependencies(input: ScheduleInput): ScheduleOutput {
  // 1. å–å¾—æ‰€æœ‰ä¾è³´é—œä¿‚
  const dependencies = await getTaskDependencies(input.tasks.map(t => t.id));

  // 2. å»ºç«‹ä¾è³´åœ–
  const dependencyGraph = buildDependencyGraph(input.tasks, dependencies);

  // 3. æ‹“æ’²æ’åºï¼ˆç¢ºä¿ä¾è³´é †åºï¼‰
  const sortedTasks = topologicalSort(dependencyGraph);

  // 4. æŒ‰ä¾è³´é †åºæ’ç¨‹
  for (const task of sortedTasks) {
    // æ‰¾åˆ°æœ€æ—©å¯ç”¨æ™‚æ®µ
    let earliestStart = getWorkDayStart();

    // æª¢æŸ¥æ‰€æœ‰å‰ç½®ä»»å‹™çš„çµæŸæ™‚é–“
    const prerequisites = dependencyGraph.getPrerequisites(task.id);
    for (const prereq of prerequisites) {
      const prereqSchedule = schedules.find(s => s.taskId === prereq.id);
      if (prereqSchedule) {
        earliestStart = max(earliestStart, prereqSchedule.endTime);
      }
    }

    // åœ¨ earliestStart ä¹‹å¾Œæ‰¾å¯ç”¨æ™‚æ®µ
    const slot = slotTracker.findSlotAfter(earliestStart, task.estimatedMinutes);
    // ...
  }
}

// æ‹“æ’²æ’åº
function topologicalSort(graph: DependencyGraph): Task[] {
  const result: Task[] = [];
  const visited = new Set<string>();
  const visiting = new Set<string>();

  function visit(taskId: string) {
    if (visited.has(taskId)) return;
    if (visiting.has(taskId)) {
      throw new Error('å¾ªç’°ä¾è³´ï¼');
    }

    visiting.add(taskId);

    for (const prereq of graph.getPrerequisites(taskId)) {
      visit(prereq.id);
    }

    visiting.delete(taskId);
    visited.add(taskId);
    result.push(graph.getTask(taskId));
  }

  for (const task of graph.getAllTasks()) {
    visit(task.id);
  }

  return result;
}
```

---

## æŠ€è¡“ä»»å‹™

- [ ] å»ºç«‹ `task_dependencies` è¡¨
- [ ] å¯¦ä½œé—œéµå­—æ¨¡å¼è­˜åˆ¥
- [ ] å¯¦ä½œ AI è¼”åŠ©ä¾è³´è­˜åˆ¥
- [ ] å»ºè­°ç¢ºèª UI
- [ ] ä»»å‹™è©³æƒ…ä¾è³´å€å¡Š
- [ ] æ‰‹å‹•æ–°å¢ä¾è³´ UI
- [ ] ä¿®æ”¹æ’ç¨‹æ¼”ç®—æ³•æ”¯æ´ä¾è³´
- [ ] å¾ªç’°ä¾è³´æª¢æ¸¬
- [ ] API: CRUD ä¾è³´é—œä¿‚

---

## æ¸¬è©¦æ¡ˆä¾‹

| # | æ¸¬è©¦ | é æœŸçµæœ |
|---|------|----------|
| 1 | æè¿°å«ã€Œç­‰...å®Œæˆå¾Œã€| AI è­˜åˆ¥å‡ºä¾è³´ |
| 2 | ç¢ºèª AI å»ºè­° | ä¾è³´é—œä¿‚å»ºç«‹ |
| 3 | æ‰‹å‹•æ–°å¢ä¾è³´ | æ­£ç¢ºå»ºç«‹ |
| 4 | æ’ç¨‹æœ‰ä¾è³´ä»»å‹™ | å‰ç½®ä»»å‹™æ’å‰é¢ |
| 5 | å¾ªç’°ä¾è³´ | å ±éŒ¯ä¸¦æç¤º |
| 6 | åˆªé™¤ä»»å‹™ | ç›¸é—œä¾è³´è‡ªå‹•åˆªé™¤ |

---

## Definition of Done

- [ ] é—œéµå­—è­˜åˆ¥æ­£å¸¸
- [ ] AI è­˜åˆ¥æ­£å¸¸
- [ ] å»ºè­°ç¢ºèªæµç¨‹æ­£å¸¸
- [ ] æ‰‹å‹•æ–°å¢åŠŸèƒ½æ­£å¸¸
- [ ] æ’ç¨‹è€ƒæ…®ä¾è³´æ­£å¸¸
- [ ] å¾ªç’°ä¾è³´æª¢æ¸¬æ­£å¸¸
- [ ] æ¸¬è©¦æ¡ˆä¾‹é€šé
