# Story S-016: ç­‰å¾…å‹ä»»å‹™è™•ç†

> **Story ID**: S-016
> **Epic**: EPIC-003 AI æ™ºæ…§æ’ç¨‹ Phase 3
> **ä¼°è¨ˆé»æ•¸**: 5
> **å„ªå…ˆç´š**: P3
> **ä¾è³´**: S-015

---

## User Story

**ä½œç‚º** ä½¿ç”¨è€…
**æˆ‘æƒ³è¦** ç­‰å¾…å‹ä»»å‹™åªä½”ç”¨ã€Œä¸»å‹•æ“ä½œæ™‚é–“ã€åœ¨è¡Œäº‹æ›†
**ä»¥ä¾¿** æ›´æº–ç¢ºåœ°è¦åŠƒæˆ‘çš„å¯¦éš›å·¥ä½œæ™‚é–“

---

## èƒŒæ™¯èªªæ˜

æœ‰äº›ä»»å‹™å¤§éƒ¨åˆ†æ™‚é–“åœ¨ã€Œç­‰å¾…ã€ï¼Œä¾‹å¦‚ï¼š
- **éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ**: æ“ä½œ 5 åˆ†é˜ï¼Œç­‰å¾… 25 åˆ†é˜
- **ç­‰å¾… CI è·‘å®Œ**: æ“ä½œ 1 åˆ†é˜ï¼Œç­‰å¾… 20 åˆ†é˜
- **ç­‰å¾…å®¢æˆ¶å›è¦†**: æ“ä½œ 5 åˆ†é˜ï¼Œç­‰å¾…æ•¸å°æ™‚

é€™é¡ä»»å‹™ä¸æ‡‰è©²ä½”ç”¨æ•´å€‹ç­‰å¾…æ™‚é–“çš„è¡Œäº‹æ›†ç©ºé–“ã€‚

---

## é©—æ”¶æ¨™æº– (Acceptance Criteria)

### AC1: å€åˆ†ä¸»å‹•æ™‚é–“å’Œç¸½æ™‚é–“
```gherkin
Given ä»»å‹™ã€Œéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒã€
When ä½¿ç”¨è€…æˆ– AI è¨­å®šæ™‚é–“
Then å¯ä»¥åˆ†åˆ¥è¨­å®šï¼š
  - ä¸»å‹•æ™‚é–“ (active_minutes): 5 åˆ†é˜
  - ç¸½æ™‚é–“ (estimated_minutes): 30 åˆ†é˜
```

### AC2: æ’ç¨‹åªä½”ç”¨ä¸»å‹•æ™‚é–“
```gherkin
Given ç­‰å¾…å‹ä»»å‹™ï¼Œä¸»å‹•æ™‚é–“ 5 åˆ†é˜ï¼Œç¸½æ™‚é–“ 30 åˆ†é˜
When AI æ’ç¨‹
Then åªä½”ç”¨ 5 åˆ†é˜çš„è¡Œäº‹æ›†æ™‚æ®µ
And æ¨™ç¤ºã€Œ+ ç­‰å¾… 25 åˆ†é˜ã€
```

### AC3: å¾ŒçºŒä»»å‹™è€ƒæ…®ç¸½æ™‚é–“
```gherkin
Given ä»»å‹™ B ä¾è³´ä»»å‹™ Aï¼ˆç­‰å¾…å‹ï¼Œç¸½æ™‚é–“ 30 åˆ†é˜ï¼‰
When AI æ’ç¨‹ä»»å‹™ B
Then ä»»å‹™ B é–‹å§‹æ™‚é–“ >= ä»»å‹™ A é–‹å§‹æ™‚é–“ + 30 åˆ†é˜
```

### AC4: AI è‡ªå‹•è­˜åˆ¥
```gherkin
Given ä»»å‹™æ¨™é¡Œç‚ºã€Œéƒ¨ç½²åˆ°æ­£å¼ç’°å¢ƒã€
When AI é ä¼°æ™‚é–“
Then è­˜åˆ¥ç‚ºç­‰å¾…å‹ä»»å‹™
And åˆ†åˆ¥é ä¼°ä¸»å‹•æ™‚é–“å’Œç¸½æ™‚é–“
```

### AC5: ç­‰å¾…æé†’
```gherkin
Given ç­‰å¾…å‹ä»»å‹™åœ¨ 09:00 é–‹å§‹
And ä¸»å‹•æ™‚é–“ 5 åˆ†é˜ï¼Œç¸½æ™‚é–“ 30 åˆ†é˜
When åˆ°é” 09:30
Then é¡¯ç¤ºæé†’ã€Œä»»å‹™å¯èƒ½å·²å®Œæˆï¼Œè«‹æª¢æŸ¥ã€
```

---

## UI è¨­è¨ˆ

### ä»»å‹™ç·¨è¼¯ - ç­‰å¾…å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç·¨è¼¯ä»»å‹™                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ æ¨™é¡Œ: [éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ____________]                       â”‚
â”‚                                                         â”‚
â”‚ ä»»å‹™é¡å‹: â¸ï¸ ç­‰å¾…ä»»å‹™                                    â”‚
â”‚                                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä¸»å‹•æ“ä½œæ™‚é–“: [5] åˆ†é˜                               â”‚ â”‚
â”‚ â”‚ ğŸ’¡ å¯¦éš›éœ€è¦ä½ æ“ä½œçš„æ™‚é–“                              â”‚ â”‚
â”‚ â”‚                                                     â”‚ â”‚
â”‚ â”‚ ç¸½ç­‰å¾…æ™‚é–“:   [30] åˆ†é˜                              â”‚ â”‚
â”‚ â”‚ ğŸ’¡ å¾é–‹å§‹åˆ°å®Œæˆçš„ç¸½æ™‚é–“                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚              [å–æ¶ˆ]  [å„²å­˜]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¡Œäº‹æ›†é¡¯ç¤º

```
09:00 â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ â¸ï¸ éƒ¨ç½² â”‚
      â”‚  5 åˆ†é˜  â”‚
09:05 â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚  â†“
      â”‚ â³ ç­‰å¾…ä¸­ (25åˆ†é˜)
      â”‚  â†“
09:30 â”€ â”€ â”€ â”€ â”€ é è¨ˆå®Œæˆ

09:30 â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ ğŸ“‹ ä¸‹ä¸€å€‹ä»»å‹™ï¼ˆä¾è³´éƒ¨ç½²å®Œæˆï¼‰             â”‚
      â”‚                                         â”‚
```

### æ’ç¨‹é è¦½ - ç­‰å¾…ä»»å‹™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â¸ï¸ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ                    â”‚
â”‚                                     â”‚
â”‚ ğŸ“ 09:00 - 09:05 (æ“ä½œ)             â”‚
â”‚ â³ 09:05 - 09:30 (ç­‰å¾…ä¸­)           â”‚
â”‚ âœ… 09:30 é è¨ˆå®Œæˆ                   â”‚
â”‚                                     â”‚
â”‚ ğŸ’¡ ç­‰å¾…æœŸé–“å¯ä»¥åšå…¶ä»–äº‹               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è³‡æ–™åº«è®Šæ›´

```sql
-- æ–°å¢ä¸»å‹•æ™‚é–“æ¬„ä½
ALTER TABLE tasks ADD COLUMN active_minutes INTEGER;

-- active_minutes: ä¸»å‹•æ“ä½œæ™‚é–“ï¼ˆç­‰å¾…å‹ä»»å‹™å°ˆç”¨ï¼‰
-- estimated_minutes: ç¸½æ™‚é–“

-- å°æ–¼éç­‰å¾…å‹ä»»å‹™ï¼Œactive_minutes = estimated_minutes æˆ– NULL
```

---

## AI é ä¼°é‚è¼¯

```typescript
const ESTIMATE_PROMPT_WAITING = `
åˆ†æé€™å€‹ä»»å‹™æ˜¯å¦ç‚ºã€Œç­‰å¾…å‹ä»»å‹™ã€ã€‚

ç­‰å¾…å‹ä»»å‹™ç‰¹å¾µï¼š
- å¤§éƒ¨åˆ†æ™‚é–“åœ¨ç­‰å¾…ç³»çµ±è™•ç†æˆ–ä»–äººå›æ‡‰
- ä¸»å‹•æ“ä½œæ™‚é–“é å°æ–¼ç¸½æ™‚é–“
- ä¾‹å¦‚ï¼šéƒ¨ç½²ã€CI/CDã€ç­‰å¾…å¯©æ ¸ã€ç­‰å¾…å›è¦†

å¦‚æœæ˜¯ç­‰å¾…å‹ä»»å‹™ï¼Œè«‹åˆ†åˆ¥ä¼°è¨ˆï¼š
1. active_minutes: ä¸»å‹•æ“ä½œæ™‚é–“
2. total_minutes: å¾é–‹å§‹åˆ°å®Œæˆçš„ç¸½æ™‚é–“

å›å‚³ JSONï¼š
{
  "isWaitingTask": true,
  "activeMinutes": 5,
  "totalMinutes": 30,
  "reasoning": "éƒ¨ç½²æ“ä½œæœ¬èº«åªéœ€è¦å¹¾åˆ†é˜ï¼Œä½†éœ€è¦ç­‰å¾…ç³»çµ±å®Œæˆ"
}

å¦‚æœä¸æ˜¯ç­‰å¾…å‹ä»»å‹™ï¼š
{
  "isWaitingTask": false,
  "estimatedMinutes": 60
}
`;

async function estimateWaitingTask(task: Task): Promise<WaitingEstimate> {
  // ... å‘¼å« AI é ä¼°
}
```

---

## æ’ç¨‹æ¼”ç®—æ³•æ•´åˆ

```typescript
function scheduleWithWaitingTasks(input: ScheduleInput): ScheduleOutput {
  for (const task of sortedTasks) {
    if (task.taskType === 'waiting') {
      // ç­‰å¾…å‹ä»»å‹™åªä½”ç”¨ä¸»å‹•æ™‚é–“
      const activeMinutes = task.activeMinutes || 5;  // é è¨­ 5 åˆ†é˜
      const totalMinutes = task.estimatedMinutes;

      const slot = slotTracker.findSlot(activeMinutes);
      if (slot) {
        schedules.push({
          taskId: task.id,
          startTime: slot.start,
          endTime: addMinutes(slot.start, activeMinutes),
          displayEndTime: addMinutes(slot.start, totalMinutes),
          taskType: 'waiting',
          waitingMinutes: totalMinutes - activeMinutes,
        });

        // åªæ¨™è¨˜ä¸»å‹•æ™‚é–“ç‚ºå·²ä½¿ç”¨
        slotTracker.markUsed({
          start: slot.start,
          end: addMinutes(slot.start, activeMinutes),
        });

        // ä½†ä¾è³´æ­¤ä»»å‹™çš„å¾ŒçºŒä»»å‹™è¦ç­‰ç¸½æ™‚é–“
        dependencyTracker.setCompletionTime(
          task.id,
          addMinutes(slot.start, totalMinutes)
        );
      }
    } else {
      // ä¸€èˆ¬ä»»å‹™...
    }
  }
}
```

---

## æŠ€è¡“ä»»å‹™

- [ ] æ–°å¢ `active_minutes` æ¬„ä½
- [ ] ä¿®æ”¹ä»»å‹™ç·¨è¼¯ UIï¼ˆç­‰å¾…å‹æ™‚é–“è¼¸å…¥ï¼‰
- [ ] ä¿®æ”¹æ’ç¨‹æ¼”ç®—æ³•ï¼ˆåªä½”ç”¨ä¸»å‹•æ™‚é–“ï¼‰
- [ ] è¡Œäº‹æ›†ç­‰å¾…ä»»å‹™è¦–è¦ºåŒ–
- [ ] AI é ä¼°æ•´åˆç­‰å¾…å‹åˆ¤æ–·
- [ ] ç­‰å¾…å®Œæˆæé†’
- [ ] å¾ŒçºŒä»»å‹™ä¾è³´è¨ˆç®—ï¼ˆç”¨ç¸½æ™‚é–“ï¼‰

---

## æ¸¬è©¦æ¡ˆä¾‹

| # | æ¸¬è©¦ | é æœŸçµæœ |
|---|------|----------|
| 1 | è¨­å®šç­‰å¾…ä»»å‹™æ™‚é–“ | ä¸»å‹•/ç¸½æ™‚é–“åˆ†é–‹ |
| 2 | æ’ç¨‹ç­‰å¾…ä»»å‹™ | åªä½”ç”¨ä¸»å‹•æ™‚é–“ |
| 3 | ä¾è³´ç­‰å¾…ä»»å‹™ | å¾ŒçºŒä»»å‹™åœ¨ç¸½æ™‚é–“å¾Œé–‹å§‹ |
| 4 | AI è­˜åˆ¥ã€Œéƒ¨ç½²ã€| è­˜åˆ¥ç‚ºç­‰å¾…å‹ |
| 5 | è¡Œäº‹æ›†é¡¯ç¤º | æ­£ç¢ºé¡¯ç¤ºç­‰å¾…ç‹€æ…‹ |
| 6 | ç­‰å¾…å®Œæˆæé†’ | æ™‚é–“åˆ°æ™‚æé†’ |

---

## Definition of Done

- [ ] ä¸»å‹•/ç¸½æ™‚é–“è¼¸å…¥æ­£å¸¸
- [ ] æ’ç¨‹åªä½”ç”¨ä¸»å‹•æ™‚é–“
- [ ] ä¾è³´è¨ˆç®—ç”¨ç¸½æ™‚é–“
- [ ] AI è­˜åˆ¥ç­‰å¾…å‹ä»»å‹™
- [ ] è¡Œäº‹æ›†è¦–è¦ºåŒ–æ­£ç¢º
- [ ] ç­‰å¾…æé†’åŠŸèƒ½æ­£å¸¸
- [ ] æ¸¬è©¦æ¡ˆä¾‹é€šé
