# Story S-014: ä¸€éµé‡æ–°æ’ç¨‹

> **Story ID**: S-014
> **Epic**: EPIC-002 AI æ™ºæ…§æ’ç¨‹ Phase 2
> **ä¼°è¨ˆé»æ•¸**: 5
> **å„ªå…ˆç´š**: P2
> **ä¾è³´**: S-006 (æ’ç¨‹æ¼”ç®—æ³•)

---

## User Story

**ä½œç‚º** ä½¿ç”¨è€…
**æˆ‘æƒ³è¦** ä¸€éµé‡æ–°æ’ç¨‹æ‰€æœ‰ä»»å‹™
**ä»¥ä¾¿** ç•¶è¨ˆç•«è®Šå‹•æ™‚å¯ä»¥å¿«é€Ÿèª¿æ•´æ•´é«”æ’ç¨‹

---

## é©—æ”¶æ¨™æº– (Acceptance Criteria)

### AC1: ä¸€éµè§¸ç™¼
```gherkin
Given ä½¿ç”¨è€…æœ‰å¤šå€‹å·²æ’ç¨‹ä»»å‹™
When é»æ“Šã€Œé‡æ–°æ’ç¨‹ã€æŒ‰éˆ•
Then ç³»çµ±é‡æ–°è¨ˆç®—æ‰€æœ‰ä»»å‹™çš„æ™‚é–“
And é¡¯ç¤ºæ–°çš„æ’ç¨‹é è¦½
```

### AC2: ä¿ç•™æ‰‹å‹•èª¿æ•´
```gherkin
Given ä»»å‹™ A è¢«ä½¿ç”¨è€…æ‰‹å‹•èª¿æ•´éæ™‚é–“
When åŸ·è¡Œä¸€éµé‡æ–°æ’ç¨‹
Then ä»»å‹™ A çš„æ™‚é–“ä¿æŒä¸è®Šï¼ˆæˆ–è©¢å•æ˜¯å¦è¦èª¿æ•´ï¼‰
And å…¶ä»–ä»»å‹™åœç¹ A é‡æ–°æ’ç¨‹
```

### AC3: è€ƒæ…®æ–°å¢/å®Œæˆçš„ä»»å‹™
```gherkin
Given è‡ªä¸Šæ¬¡æ’ç¨‹å¾Œæ–°å¢äº† 2 å€‹ä»»å‹™
And å®Œæˆäº† 1 å€‹ä»»å‹™
When åŸ·è¡Œä¸€éµé‡æ–°æ’ç¨‹
Then æ–°ä»»å‹™ç´å…¥æ’ç¨‹
And å·²å®Œæˆä»»å‹™ä¸å†æ’ç¨‹
```

### AC4: æ’ç¨‹è®Šå‹•æ‘˜è¦
```gherkin
Given é‡æ–°æ’ç¨‹å®Œæˆ
When é¡¯ç¤ºçµæœ
Then é¡¯ç¤ºè®Šå‹•æ‘˜è¦ï¼š
  - æ–°æ’å…¥: 2 å€‹ä»»å‹™
  - æ™‚é–“èª¿æ•´: 3 å€‹ä»»å‹™
  - ç§»é™¤: 1 å€‹ä»»å‹™ï¼ˆå·²å®Œæˆï¼‰
  - ç„¡æ³•æ’å…¥: 1 å€‹ä»»å‹™
```

### AC5: å°è©±è§¸ç™¼
```gherkin
Given ä½¿ç”¨è€…èªªã€Œé‡æ–°æ’ä¸€ä¸‹ã€æˆ–ã€Œrescheduleã€
When AI è™•ç†è¨Šæ¯
Then è§¸ç™¼ä¸€éµé‡æ–°æ’ç¨‹
And é¡¯ç¤ºæ’ç¨‹é è¦½
```

---

## UI è¨­è¨ˆ

### è§¸ç™¼æŒ‰éˆ•ä½ç½®

**è¡Œäº‹æ›†é é¢**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… è¡Œäº‹æ›†                                 [ğŸ”„ é‡æ–°æ’ç¨‹] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ’ç¨‹é è¦½é¢æ¿**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“… æ’ç¨‹é è¦½                              [ğŸ”„ é‡æ–°æ’ç¨‹] X â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ...                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é‡æ–°æ’ç¨‹é¸é …

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ é‡æ–°æ’ç¨‹                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ æ’ç¨‹ç¯„åœï¼š                                               â”‚
â”‚ â—‹ ä»Šå¤©                                                  â”‚
â”‚ â—‹ æœ¬é€±                                                  â”‚
â”‚ â— æ‰€æœ‰æœªå®Œæˆä»»å‹™                                         â”‚
â”‚                                                         â”‚
â”‚ é¸é …ï¼š                                                   â”‚
â”‚ â˜‘ ä¿ç•™æˆ‘æ‰‹å‹•èª¿æ•´éçš„ä»»å‹™æ™‚é–“                             â”‚
â”‚ â˜ å®Œå…¨é‡æ–°è¨ˆç®—ï¼ˆå¿½ç•¥æ‰‹å‹•èª¿æ•´ï¼‰                           â”‚
â”‚                                                         â”‚
â”‚              [å–æ¶ˆ]  [é–‹å§‹é‡æ–°æ’ç¨‹]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®Šå‹•æ‘˜è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… é‡æ–°æ’ç¨‹å®Œæˆ                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚ ğŸ“Š è®Šå‹•æ‘˜è¦                                              â”‚
â”‚                                                         â”‚
â”‚ ğŸ†• æ–°æ’å…¥: 2 å€‹ä»»å‹™                                      â”‚
â”‚    â€¢ æº–å‚™ Q1 å ±å‘Š â†’ é€±ä¸‰ 14:00                          â”‚
â”‚    â€¢ å¯©æ ¸æ–‡ä»¶ â†’ é€±å›› 09:00                              â”‚
â”‚                                                         â”‚
â”‚ ğŸ”„ æ™‚é–“èª¿æ•´: 3 å€‹ä»»å‹™                                    â”‚
â”‚    â€¢ å°èª²ç¨‹å¤§ç¶±: é€±ä¸€ 09:00 â†’ é€±ä¸€ 14:00                â”‚
â”‚    â€¢ æº–å‚™ç°¡å ±: é€±äºŒ 14:00 â†’ é€±äºŒ 09:00                  â”‚
â”‚    â€¢ æ¸¬è©¦åŠŸèƒ½: é€±ä¸‰ 09:00 â†’ é€±ä¸‰ 16:00                  â”‚
â”‚                                                         â”‚
â”‚ âœ… å·²å®Œæˆ: 1 å€‹ä»»å‹™ï¼ˆå·²ç§»é™¤ï¼‰                            â”‚
â”‚                                                         â”‚
â”‚ âš ï¸ ç„¡æ³•æ’å…¥: 1 å€‹ä»»å‹™                                    â”‚
â”‚    â€¢ å¤§å‹ä¼åŠƒæ¡ˆ (8hr) - å¯ç”¨æ™‚é–“ä¸è¶³                     â”‚
â”‚                                                         â”‚
â”‚                     [æŸ¥çœ‹è©³ç´°]  [ç¢ºèª]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é‡æ–°æ’ç¨‹é‚è¼¯

```typescript
interface RescheduleOptions {
  scope: 'today' | 'week' | 'all';
  preserveManualAdjustments: boolean;
}

interface RescheduleResult {
  newlyScheduled: Task[];
  timeAdjusted: Array<{
    task: Task;
    oldTime: { start: Date; end: Date };
    newTime: { start: Date; end: Date };
  }>;
  removed: Task[];
  unscheduled: Array<{ task: Task; reason: string }>;
}

async function rescheduleAll(
  userId: string,
  options: RescheduleOptions
): Promise<RescheduleResult> {
  // 1. å–å¾—æ‰€æœ‰ç›¸é—œä»»å‹™
  const tasks = await getTasksForReschedule(userId, options.scope);

  // 2. åˆ†é¡ä»»å‹™
  const manuallyAdjusted = tasks.filter(t => t.isManuallyScheduled);
  const autoScheduled = tasks.filter(t => !t.isManuallyScheduled);
  const unscheduled = tasks.filter(t => !t.startDate);

  // 3. å»ºç«‹å›ºå®šæ™‚æ®µï¼ˆæ‰‹å‹•èª¿æ•´çš„ä»»å‹™ï¼‰
  const fixedSlots = options.preserveManualAdjustments
    ? manuallyAdjusted.map(t => ({
        taskId: t.id,
        start: t.startDate,
        end: t.endDate,
      }))
    : [];

  // 4. é‡æ–°æ’ç¨‹å…¶ä»–ä»»å‹™
  const availableSlots = await getAvailableSlots(userId, options.scope, fixedSlots);

  const scheduleResult = scheduleTasksV2({
    tasks: [...autoScheduled, ...unscheduled],
    availableSlots,
    // ... å…¶ä»–åƒæ•¸
  });

  // 5. æ¯”å°è®Šå‹•
  const changes = compareSchedules(tasks, scheduleResult.schedules);

  return {
    newlyScheduled: changes.new,
    timeAdjusted: changes.adjusted,
    removed: changes.removed,
    unscheduled: scheduleResult.unscheduled,
  };
}
```

---

## æ¨™è¨˜æ‰‹å‹•èª¿æ•´

```typescript
// ç•¶ä½¿ç”¨è€…åœ¨æ’ç¨‹é è¦½ä¸­æ‰‹å‹•èª¿æ•´æ™‚é–“
async function markAsManuallyAdjusted(taskId: string) {
  await supabase
    .from('tasks')
    .update({ is_manually_scheduled: true })
    .eq('id', taskId);
}

// è³‡æ–™åº«æ¬„ä½
// ALTER TABLE tasks ADD COLUMN is_manually_scheduled BOOLEAN DEFAULT false;
```

---

## æŠ€è¡“ä»»å‹™

- [ ] æ–°å¢ `is_manually_scheduled` æ¬„ä½
- [ ] å¯¦ä½œé‡æ–°æ’ç¨‹é¸é … UI
- [ ] å¯¦ä½œ `rescheduleAll` é‚è¼¯
- [ ] å¯¦ä½œè®Šå‹•æ¯”å°é‚è¼¯
- [ ] è®Šå‹•æ‘˜è¦ UI
- [ ] å°è©±è§¸ç™¼ï¼ˆã€Œé‡æ–°æ’ã€é—œéµå­—ï¼‰
- [ ] è¡Œäº‹æ›†é é¢æŒ‰éˆ•
- [ ] API: POST /api/schedule/reschedule

---

## API ç«¯é»

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| POST | `/api/schedule/reschedule` | åŸ·è¡Œé‡æ–°æ’ç¨‹ |

**Request**
```json
{
  "scope": "all",
  "preserveManualAdjustments": true
}
```

**Response**
```json
{
  "success": true,
  "result": {
    "newlyScheduled": [...],
    "timeAdjusted": [...],
    "removed": [...],
    "unscheduled": [...]
  }
}
```

---

## æ¸¬è©¦æ¡ˆä¾‹

| # | æ¸¬è©¦ | é æœŸçµæœ |
|---|------|----------|
| 1 | ä¸€éµé‡æ–°æ’ç¨‹ | æ‰€æœ‰ä»»å‹™é‡æ–°è¨ˆç®— |
| 2 | ä¿ç•™æ‰‹å‹•èª¿æ•´ | æ‰‹å‹•ä»»å‹™ä¸è®Š |
| 3 | ä¸ä¿ç•™æ‰‹å‹•èª¿æ•´ | å…¨éƒ¨é‡æ–°è¨ˆç®— |
| 4 | æœ‰æ–°ä»»å‹™ | æ–°ä»»å‹™ç´å…¥æ’ç¨‹ |
| 5 | æœ‰å®Œæˆä»»å‹™ | å®Œæˆä»»å‹™ç§»é™¤ |
| 6 | å°è©±è§¸ç™¼ | æ­£ç¢ºè­˜åˆ¥ä¸¦åŸ·è¡Œ |
| 7 | è®Šå‹•æ‘˜è¦ | æ­£ç¢ºé¡¯ç¤º |

---

## Definition of Done

- [ ] ä¸€éµè§¸ç™¼åŠŸèƒ½æ­£å¸¸
- [ ] é¸é …è¨­å®šæ­£å¸¸
- [ ] ä¿ç•™æ‰‹å‹•èª¿æ•´æ­£å¸¸
- [ ] è®Šå‹•æ‘˜è¦æ­£ç¢ºé¡¯ç¤º
- [ ] å°è©±è§¸ç™¼æ­£å¸¸
- [ ] API æ­£å¸¸é‹ä½œ
- [ ] æ¸¬è©¦æ¡ˆä¾‹é€šé
